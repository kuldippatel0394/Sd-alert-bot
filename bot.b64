import os, time, requests, yfinance as yf, numpy as np
from datetime import datetime, timezone

TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN", "")
CHAT = os.environ.get("TELEGRAM_CHAT_ID", "")
PAIRS = {"EURJPY": "EURJPY=X", "EURUSD": "EURUSD=X", "GBPUSD": "GBPUSD=X", "USDJPY": "USDJPY=X"}
PIPS = 0.0015
COOLDOWN = 300
ACCOUNT = 1000.0
RISK = 1.0
JPY = ["EURJPY", "USDJPY"]

def msg(text):
    try:
        requests.post("https://api.telegram.org/bot" + TOKEN + "/sendMessage", data={"chat_id": CHAT, "text": text}, timeout=10)
    except:
        pass

def candles(ticker, interval, period):
    try:
        df = yf.download(ticker, interval=interval, period=period, progress=False)
        df.columns = [c[0] if isinstance(c, tuple) else c for c in df.columns]
        return df[["Open", "High", "Low", "Close"]].dropna()
    except:
        import pandas as pd
        return pd.DataFrame()

def trend(ticker):
    df = candles(ticker, "1d", "3mo")
    if df.empty or len(df) < 20:
        return "UNKNOWN"
    c = df["Close"].values
    sma20 = np.mean(c[-20:])
    sma50 = np.mean(c[-50:]) if len(c) >= 50 else np.mean(c)
    hh = sum(1 for i in range(-5, -1) if df["High"].values[i] > df["High"].values[i-1])
    hl = sum(1 for i in range(-5, -1) if df["Low"].values[i] > df["Low"].values[i-1])
    lh = sum(1 for i in range(-5, -1) if df["High"].values[i] < df["High"].values[i-1])
    ll = sum(1 for i in range(-5, -1) if df["Low"].values[i] < df["Low"].values[i-1])
    if c[-1] > sma20 > sma50 and hh >= 2 and hl >= 2:
        return "BULLISH"
    if c[-1] < sma20 < sma50 and lh >= 2 and ll >= 2:
        return "BEARISH"
    return "RANGING"

def session(pair):
    h = datetime.now(timezone.utc).hour
    if pair in JPY:
        return True
    return 7 <= h < 21

def zones(ticker):
    result = []
    for iv, label, per in [("1d", "D1", "6mo"), ("4h", "H4", "60d")]:
        df = candles(ticker, iv, per)
        if df.empty or len(df) < 50:
            continue
        df = df.tail(100).reset_index(drop=True)
        for i in range(3, len(df) - 3):
            c = df.iloc[i]
            body = abs(c["Close"] - c["Open"])
            rng = c["High"] - c["Low"]
            if rng == 0:
                continue
            if c["Close"] < c["Open"] and body > rng * 0.5:
                downs = sum(1 for j in range(1, 4) if (i-j) >= 0 and df.iloc[i-j]["Close"] < df.iloc[i-j]["Open"])
                if downs >= 2:
                    result.append({"type": "SUPPLY", "tf": label, "top": float(c["High"]), "bottom": float(c["Open"])})
            if c["Close"] > c["Open"] and body > rng * 0.5:
                ups = sum(1 for j in range(1, 4) if (i-j) >= 0 and df.iloc[i-j]["Close"] > df.iloc[i-j]["Open"])
                if ups >= 2:
                    result.append({"type": "DEMAND", "tf": label, "top": float(c["Open"]), "bottom": float(c["Low"])})
    seen = []
    for z in result:
        mid = (z["top"] + z["bottom"]) / 2
        if not any(abs(mid - (s["top"] + s["bottom"]) / 2) < PIPS * 3 for s in seen):
            seen.append(z)
    return seen

def load():
    import json
    try:
        if os.path.exists("state.txt"):
            return json.load(open("state.txt"))
    except:
        pass
    return {"breaks": [], "alerts": {}}

def save(state):
    import json
    try:
        json.dump(state, open("state.txt", "w"))
    except:
        pass

def lot(entry, sl, pair):
    diff = abs(entry - sl)
    if diff == 0:
        return 0.01
    pv = 1000 if "JPY" in pair else 10000
    return max(0.01, round((ACCOUNT * RISK / 100) / (diff * pv), 2))

def scan(pair, ticker, state):
    df = candles(ticker, "5m", "1d")
    if df.empty:
        return
    price = float(df["Close"].iloc[-1])
    now = time.time()
    d1 = trend(ticker)
    sess = session(pair)
    zlist = zones(ticker)
    breaks = state.get("breaks", [])
    alerts = state.get("alerts", {})
    print(pair + " " + str(round(price, 5)) + " D1=" + d1)

    for z in zlist:
        zid = pair + z["tf"] + z["type"] + str(round(z["top"], 3))
        label = z["tf"] + " " + z["type"]
        broken = zid in breaks
        at_zone = abs(price - (z["top"] + z["bottom"]) / 2) <= PIPS * 3
        above = price > z["top"]
        below = price < z["bottom"]

        if not broken:
            if z["type"] == "SUPPLY" and above:
                breaks.append(zid)
                state["breaks"] = breaks
                msg("BREAKOUT - " + pair + "\nBULLISH BREAKOUT\nZone: " + label + "\nLevel: " + str(round(z["top"], 5)) + "\nPrice: " + str(round(price, 5)) + "\nD1: " + d1 + "\nWait for RETEST then BUY")
            elif z["type"] == "DEMAND" and below:
                breaks.append(zid)
                state["breaks"] = breaks
                msg("BREAKOUT - " + pair + "\nBEARISH BREAKOUT\nZone: " + label + "\nLevel: " + str(round(z["bottom"], 5)) + "\nPrice: " + str(round(price, 5)) + "\nD1: " + d1 + "\nWait for RETEST then SELL")
            elif at_zone:
                aid = zid + "_touch"
                if now - alerts.get(aid, 0) < COOLDOWN:
                    continue
                if z["type"] == "SUPPLY":
                    tdir = "SELL"
                    sl = z["top"] + PIPS * 3
                    tp = z["bottom"] - PIPS * 9
                    trend_ok = d1 == "BEARISH"
                    note = "Unbroken Supply - Nathan SELLS here"
                else:
                    tdir = "BUY"
                    sl = z["bottom"] - PIPS * 3
                    tp = z["top"] + PIPS * 9
                    trend_ok = d1 == "BULLISH"
                    note = "Unbroken Demand - Nathan BUYS here"
                alerts[aid] = now
                state["alerts"] = alerts
                valid = "VALID" if trend_ok and sess else "WEAK - check trend and session"
                msg("ZONE ALERT - " + pair + "\n" + valid + "\n" + tdir + " - " + note + "\nZone: " + label + "\nPrice: " + str(round(price, 5)) + "\nSL: " + str(round(sl, 5)) + "\nTP: " + str(round(tp, 5)) + "\nLot: " + str(lot(price, sl, pair)) + "\nD1: " + d1 + "\nSession: " + ("OK" if sess else "WAIT") + "\nConfirm on M5 then M1!")
        else:
            if not at_zone:
                continue
            aid = zid + "_retest"
            if now - alerts.get(aid, 0) < COOLDOWN:
                continue
            if z["type"] == "SUPPLY":
                tdir = "BUY"
                sl = z["top"] - PIPS * 3
                tp = z["top"] + PIPS * 9
                trend_ok = d1 == "BULLISH"
                note = "Broken Supply retested - Old Resistance now Support - Nathan BUYS"
            else:
                tdir = "SELL"
                sl = z["bottom"] + PIPS * 3
                tp = z["bottom"] - PIPS * 9
                trend_ok = d1 == "BEARISH"
                note = "Broken Demand retested - Old Support now Resistance - Nathan SELLS"
            alerts[aid] = now
            state["alerts"] = alerts
            valid = "VALID" if trend_ok and sess else "WEAK - check trend and session"
            msg("RETEST ALERT - " + pair + "\n" + valid + "\n" + tdir + " - " + note + "\nZone: " + label + "\nPrice: " + str(round(price, 5)) + "\nSL: " + str(round(sl, 5)) + "\nTP: " + str(round(tp, 5)) + "\nLot: " + str(lot(price, sl, pair)) + "\nD1: " + d1 + "\nSession: " + ("OK" if sess else "WAIT") + "\nConfirm on M5 then M1!")

def main():
    print("Bot starting - " + str(datetime.now(timezone.utc)))
    if not TOKEN or not CHAT:
        print("ERROR: Missing env vars")
        return
    state = load()
    for pair, ticker in PAIRS.items():
        try:
            scan(pair, ticker, state)
        except Exception as e:
            print("Error " + pair + ": " + str(e))
    save(state)
    print("Done")

if __name__ == "__main__":
    main()
